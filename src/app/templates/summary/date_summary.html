<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Date Report</title>
    <base href="../../" target="_blank">
    <link rel="stylesheet" href="static/style/date_summary.css">
</head>

<body>
    <div id="app">
        <h1>Date {{ date_str }}</h1>
        <div id="date_summary" v-html="show_date_summary()"></div>
        <div id="time_range" ref="time_range"></div>

        <table class="intervals">
            <thead>
            <tr>
                <th scope="col">Type</th>
                <th scope="col">Interval Start - Interval End</th>
                <th scope="col">Interval Duration</th>
                <th scope="col">Percentage</th>
            </tr>
            </thead>
            <tbody>

            <tr v-for="log in logs">
                <td>{{ types[log.type].name_path }}</td>
                <td>{{ log.start.toLocaleTimeString('en-GB') }} - {{ log.end.toLocaleTimeString('en-GB') }}</td>
                <td>{{ (log.end - log.start) | milliseconds_to_hms }}</td>
                <td>{{ (log.end - log.start) | compute_percentage }}</td>
            </tr>

            </tbody>
        </table>
    </div>
</body>

<script src="static/script/include/echarts.min.js"></script>
<script src="static/script/include/vue.min.js"></script>
<script src="static/script/utils/req.js"></script>
<script src="static/script/utils/api.js"></script>
<script src="static/script/utils/utils.js"></script>
<script src="static/script/chart/gantt_chart.js"></script>
<script>
    let app = new Vue({
        el: '#app',
        data: {
            date_str: window.location.href.split('/').pop(),
            date_summary: "",
            types: [],
            logs: [],
        },
        methods: {
            show_date_summary: function() {
                this.date_summary = synreq(DATE_SUMMARY_API(this.date_str));
                return this.date_summary ? this.date_summary : "<p>No summary</p>";
            },
            draw_gantt: function() {
                let date_start = new Date(this.date_str).setHours(0, 0, 0, 0);
                let date_end = date_start + 86400 * 1000;
                let date_range = {start: date_start, end: date_end};
                this.time_range_chart.setOption(create_date_gantt_option(this.logs, this.types, date_range));
            }
        },
        filters: {
            milliseconds_to_hms: function(milliseconds) {
                let seconds = milliseconds / 1000;

                let hour = Math.floor(seconds / 3600);
                let minute = Math.floor(seconds % 3600 / 60);
                let second = seconds % 60;

                hour = leading_zero(hour.toString());
                minute = leading_zero(minute.toString());
                second = leading_zero(second.toString());

                duration_string = `${hour}:${minute}:${second}`
                return duration_string;
            },
            compute_percentage: function(milliseconds) {
                return (milliseconds / (86400 * 1000) * 100).toFixed(2) + '%';
            }
        },
        created: function() {
        },
        mounted: function() {
            this.time_range_chart = echarts.init(this.$refs.time_range);
            let promise_types = req(LOG_TYPE_API());
            let promise_logs = req(LOG_DATE_API(this.date_str));
            Promise.all([promise_types, promise_logs]).then(res => {
                let [types, logs] = res;
                console.log(logs);
                this.types = add_paths(types);
                this.logs = Object.values(logs);
                this.logs.forEach(log => {
                    log.comment = types[log.type].name_path;
                    log.start = new Date(log.start.replaceAll('-', '/'));
                    log.end = new Date(log.end.replaceAll('-', '/'));
                })
                this.logs.sort((log1, log2) => log1.start - log2.start);
                console.log(this.logs);
                this.draw_gantt();
            });
        }
    });
</script>
</html>